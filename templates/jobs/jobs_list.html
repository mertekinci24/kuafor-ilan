{% extends 'base.html' %}

{% block title %}İş İlanları - Kuaför İlan{% endblock %}

{% block extra_css %}
<style>
    /* Jobs List Özel Stilleri */
    .jobs-page {
        background: #f8fafc;
        min-height: calc(100vh - 70px);
        padding: 2rem 0;
    }

    .jobs-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2rem;
        align-items: start;
    }

    /* Filters Sidebar */
    .filters-sidebar {
        position: sticky;
        top: 90px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .filters-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .filters-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filters-content {
        padding: 1.5rem;
    }

    .filter-group {
        margin-bottom: 1.5rem;
    }

    .filter-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .filter-input,
    .filter-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: var(--transition);
        background: white;
    }

    .filter-input:focus,
    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(10, 102, 194, 0.1);
    }

    .salary-range {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }

    .filter-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

    .filter-btn {
        flex: 1;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .filter-btn.primary {
        background: var(--gradient-primary);
        color: white;
    }

    .filter-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(10, 102, 194, 0.3);
    }

    .filter-btn.secondary {
        background: transparent;
        color: var(--text-muted);
        border: 2px solid var(--border-color);
    }

    .filter-btn.secondary:hover {
        background: #f8fafc;
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* Results Count */
    .results-header {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-color);
    }

    .results-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .results-count {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .results-filters {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .active-filter {
        background: #e0f2fe;
        color: var(--primary-color);
        padding: 0.25rem 0.75rem;
        border-radius: 16px;
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .filter-remove {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        font-size: 0.875rem;
        padding: 0;
        margin-left: 0.25rem;
    }

    /* Job Cards */
    .jobs-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .job-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-color);
        transition: var(--transition);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .job-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--gradient-primary);
        transform: scaleY(0);
        transition: var(--transition);
    }

    .job-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .job-card:hover::before {
        transform: scaleY(1);
    }

    .job-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .job-company-avatar {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background: var(--gradient-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.25rem;
        flex-shrink: 0;
        margin-right: 1rem;
    }

    .job-info {
        flex: 1;
    }

    .job-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        text-decoration: none;
        display: block;
    }

    .job-title:hover {
        color: var(--primary-color);
    }

    .job-company {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
    }

    .job-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .job-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .job-badge.urgent {
        background: #fee2e2;
        color: #dc2626;
    }

    .job-badge.new {
        background: #dcfce7;
        color: #16a34a;
    }

    .job-badge.featured {
        background: #fef3c7;
        color: #d97706;
    }

    .job-meta {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .job-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .job-meta-icon {
        width: 16px;
        height: 16px;
        color: var(--primary-color);
    }

    .job-description {
        color: var(--text-color);
        line-height: 1.6;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .job-footer {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .job-salary {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .job-actions {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
    }

    .job-action-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .apply-btn {
        background: var(--gradient-primary);
        color: white;
    }

    .apply-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(10, 102, 194, 0.3);
    }

    .apply-btn.applied {
        background: var(--success-color);
        cursor: default;
    }

    .apply-btn.applied:hover {
        transform: none;
    }

    .save-btn {
        background: transparent;
        color: var(--text-muted);
        border: 2px solid var(--border-color);
    }

    .save-btn:hover {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .save-btn.saved {
        background: #fef3c7;
        color: #d97706;
        border-color: #fed7aa;
    }

    /* Pagination */
    .pagination-container {
        margin-top: 2rem;
        display: flex;
        justify-content: center;
    }

    .pagination {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .pagination a,
    .pagination span {
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-color);
        background: white;
        transition: var(--transition);
        font-weight: 500;
    }

    .pagination a:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .pagination .current {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* No Results */
    .no-results {
        text-align: center;
        background: white;
        border-radius: 16px;
        padding: 3rem 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border-color);
    }

    .no-results-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .no-results-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .no-results-text {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }

    /* Loading */
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 3rem;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .jobs-container {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .filters-sidebar {
            position: static;
            order: 2;
        }
        
        .jobs-content {
            order: 1;
        }
    }

    @media (max-width: 768px) {
        .jobs-page {
            padding: 1rem 0;
        }
        
        .jobs-container {
            padding: 0 1rem;
        }
        
        .job-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .job-company-avatar {
            margin-right: 0;
            margin-bottom: 1rem;
        }
        
        .job-meta {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .job-footer {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        
        .job-actions {
            margin-left: 0;
            justify-content: stretch;
        }
        
        .job-action-btn {
            flex: 1;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .salary-range {
            grid-template-columns: 1fr;
        }
        
        .filter-actions {
            flex-direction: column;
        }
        
        .results-filters {
            flex-direction: column;
        }
    }

    /* Animation */
    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stagger-animation {
        animation-delay: var(--delay, 0s);
    }
</style>
{% endblock %}

{% block content %}
<div class="jobs-page">
    <div class="jobs-container">
        <!-- Filters Sidebar -->
        <aside class="filters-sidebar fade-in-up">
            <div class="filters-header">
                <h2 class="filters-title">
                    <i class="fas fa-filter"></i>
                    Filtreler
                </h2>
            </div>
            
            <div class="filters-content">
                <form method="get" action="{% url 'jobs:list' %}" id="filtersForm">
                    <div class="filter-group">
                        <label class="filter-label" for="search">
                            <i class="fas fa-search"></i>
                            Arama
                        </label>
                        <input type="text" id="search" name="search" class="filter-input" 
                               placeholder="İş başlığı, açıklama veya şirket..." 
                               value="{{ current_filters.search|default:'' }}">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="category">
                            <i class="fas fa-tag"></i>
                            Kategori
                        </label>
                        <select id="category" name="category" class="filter-select">
                            <option value="">Tüm Kategoriler</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}" 
                                        {% if current_filters.category == cat.id|stringformat:"s" %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="city">
                            <i class="fas fa-map-marker-alt"></i>
                            Şehir
                        </label>
                        <select id="city" name="city" class="filter-select">
                            <option value="">Tüm Şehirler</option>
                            {% for city in cities %}
                                <option value="{{ city }}" 
                                        {% if current_filters.city == city %}selected{% endif %}>
                                    {{ city }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-money-bill-wave"></i>
                            Maaş Aralığı (₺)
                        </label>
                        <div class="salary-range">
                            <input type="number" name="salary_min" class="filter-input" 
                                   placeholder="Min" value="{{ current_filters.salary_min|default:'' }}">
                            <input type="number" name="salary_max" class="filter-input" 
                                   placeholder="Max" value="{{ current_filters.salary_max|default:'' }}">
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button type="submit" class="filter-btn primary">
                            <i class="fas fa-search"></i>
                            Filtrele
                        </button>
                        <button type="button" class="filter-btn secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Temizle
                        </button>
                    </div>
                </form>
            </div>
        </aside>

        <!-- Jobs Content -->
        <main class="jobs-content">
            <!-- Results Header -->
            <div class="results-header fade-in-up">
                <h1 class="results-title">İş İlanları</h1>
                <p class="results-count">
                    {% if page_obj.paginator.count %}
                        <i class="fas fa-briefcase"></i>
                        {{ page_obj.paginator.count }} ilan bulundu
                        {% if current_filters.search or current_filters.category or current_filters.city %}
                            (filtrelenmiş)
                        {% endif %}
                    {% else %}
                        Henüz ilan bulunmuyor
                    {% endif %}
                </p>
                
                <!-- Active Filters -->
                {% if current_filters.search or current_filters.category or current_filters.city or current_filters.salary_min or current_filters.salary_max %}
                <div class="results-filters">
                    {% if current_filters.search %}
                        <span class="active-filter">
                            <i class="fas fa-search"></i>
                            "{{ current_filters.search }}"
                            <button class="filter-remove" onclick="removeFilter('search')">&times;</button>
                        </span>
                    {% endif %}
                    
                    {% if current_filters.category %}
                        <span class="active-filter">
                            <i class="fas fa-tag"></i>
                            {% for cat in categories %}
                                {% if cat.id|stringformat:"s" == current_filters.category %}{{ cat.name }}{% endif %}
                            {% endfor %}
                            <button class="filter-remove" onclick="removeFilter('category')">&times;</button>
                        </span>
                    {% endif %}
                    
                    {% if current_filters.city %}
                        <span class="active-filter">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ current_filters.city }}
                            <button class="filter-remove" onclick="removeFilter('city')">&times;</button>
                        </span>
                    {% endif %}
                    
                    {% if current_filters.salary_min or current_filters.salary_max %}
                        <span class="active-filter">
                            <i class="fas fa-money-bill-wave"></i>
                            {% if current_filters.salary_min %}₺{{ current_filters.salary_min }}{% else %}0{% endif %}
                            -
                            {% if current_filters.salary_max %}₺{{ current_filters.salary_max }}{% else %}∞{% endif %}
                            <button class="filter-remove" onclick="removeFilter('salary')">&times;</button>
                        </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Job Listings -->
            <div class="jobs-list">
                {% if page_obj %}
                    {% for job in page_obj %}
                        <div class="job-card fade-in-up stagger-animation" style="--delay: {{ forloop.counter0|floatformat:1|add:'0.1' }}s" onclick="goToJob({{ job.id }})">
                            <div class="job-header">
                                <div style="display: flex; align-items: flex-start; flex: 1;">
                                    <div class="job-company-avatar">
                                        {{ job.business.first_name|first|upper }}{{ job.business.last_name|first|upper }}
                                    </div>
                                    
                                    <div class="job-info">
                                        <a href="{% url 'jobs:detail' job.id %}" class="job-title" onclick="event.stopPropagation()">
                                            {{ job.title }}
                                        </a>
                                        <div class="job-company">
                                            {{ job.business.get_full_name|default:job.business.email }}
                                        </div>
                                        
                                        <div class="job-badges">
                                            {% if job.is_urgent %}
                                                <span class="job-badge urgent">
                                                    <i class="fas fa-bolt"></i>
                                                    Acil
                                                </span>
                                            {% endif %}
                                            
                                            {% if job.created_at|timesince|slice:":1" == "0" %}
                                                <span class="job-badge new">
                                                    <i class="fas fa-star"></i>
                                                    Yeni
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="job-meta">
                                <div class="job-meta-item">
                                    <i class="fas fa-map-marker-alt job-meta-icon"></i>
                                    {{ job.city }}{% if job.district %}, {{ job.district }}{% endif %}
                                </div>
                                <div class="job-meta-item">
                                    <i class="fas fa-tag job-meta-icon"></i>
                                    {{ job.category.name }}
                                </div>
                                <div class="job-meta-item">
                                    <i class="fas fa-eye job-meta-icon"></i>
                                    {{ job.views_count }} görüntülenme
                                </div>
                                <div class="job-meta-item">
                                    <i class="fas fa-clock job-meta-icon"></i>
                                    {{ job.created_at|timesince }} önce
                                </div>
                            </div>
                            
                            <div class="job-description">
                                {{ job.description|truncatewords:25 }}
                            </div>
                            
                            <div class="job-footer">
                                <div class="job-salary">
                                    {% if job.salary_min and job.salary_max %}
                                        ₺{{ job.salary_min|floatformat:0 }} - ₺{{ job.salary_max|floatformat:0 }}
                                    {% elif job.salary_min %}
                                        ₺{{ job.salary_min|floatformat:0 }}+
                                    {% else %}
                                        Maaş Görüşülür
                                    {% endif %}
                                </div>
                                
                                <div class="job-actions">
                                    <button class="job-action-btn save-btn" onclick="event.stopPropagation(); saveJob({{ job.id }})" title="Kaydet">
                                        <i class="fas fa-bookmark"></i>
                                        Kaydet
                                    </button>
                                    <button class="job-action-btn apply-btn" onclick="event.stopPropagation(); applyJob({{ job.id }})">
                                        <i class="fas fa-paper-plane"></i>
                                        Başvur
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-results fade-in-up">
                        <div class="no-results-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 class="no-results-title">Aradığınız kriterlere uygun ilan bulunamadı</h3>
                        <p class="no-results-text">
                            Filtreleri değiştirerek yeniden deneyebilir veya tüm ilanları görüntüleyebilirsiniz.
                        </p>
                        <button class="btn btn-primary" onclick="clearFilters()">
                            <i class="fas fa-refresh"></i>
                            Tüm İlanları Görüntüle
                        </button>
                    </div>
                {% endif %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <div class="pagination-container">
                    <div class="pagination">
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" title="İlk Sayfa">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" title="Önceki">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="current">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" title="Sonraki">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" title="Son Sayfa">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Job navigation
    function goToJob(jobId) {
        window.location.href = `{% url 'jobs:detail' 0 %}`.replace('0', jobId);
    }
    
    // Apply job function
    function applyJob(jobId) {
        {% if not user.is_authenticated %}
            App.showToast('Başvuru yapmak için giriş yapmanız gerekiyor.', 'warning');
            setTimeout(() => {
                window.location.href = '{% url "auth:login" %}?next=' + encodeURIComponent(window.location.pathname);
            }, 1500);
            return;
        {% endif %}
        
        {% if user.user_type != 'jobseeker' %}
            App.showToast('Sadece iş arayanlar başvuru yapabilir.', 'warning');
            return;
        {% endif %}
        
        // Show loading
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Başvuruluyor...';
        button.disabled = true;
        
        // Make AJAX request
        fetch(`{% url 'jobs:apply' 0 %}`.replace('0', jobId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': App.getCsrfToken()
            },
            body: JSON.stringify({
                cover_letter: ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                button.innerHTML = '<i class="fas fa-check"></i> Başvuruldu';
                button.classList.remove('apply-btn');
                button.classList.add('applied');
                App.showToast(data.message, 'success');
            } else {
                button.innerHTML = originalText;
                button.disabled = false;
                App.showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.innerHTML = originalText;
            button.disabled = false;
            App.showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'danger');
        });
    }
    
    // Save job function
    function saveJob(jobId) {
        {% if not user.is_authenticated %}
            App.showToast('İlan kaydetmek için giriş yapmanız gerekiyor.', 'warning');
            return;
        {% endif %}
        
        {% if user.user_type != 'jobseeker' %}
            App.showToast('Sadece iş arayanlar ilan kaydedebilir.', 'warning');
            return;
        {% endif %}
        
        const button = event.target;
        const icon = button.querySelector('i');
        const originalIcon = icon.className;
        
        icon.className = 'fas fa-spinner fa-spin';
        
        fetch(`{% url 'jobs:save' 0 %}`.replace('0', jobId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': App.getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.saved) {
                    button.classList.add('saved');
                    icon.className = 'fas fa-bookmark';
                    button.innerHTML = '<i class="fas fa-bookmark"></i> Kaydedildi';
                } else {
                    button.classList.remove('saved');
                    icon.className = 'far fa-bookmark';
                    button.innerHTML = '<i class="far fa-bookmark"></i> Kaydet';
                }
                App.showToast(data.message, 'success');
            } else {
                icon.className = originalIcon;
                App.showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            icon.className = originalIcon;
            App.showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'danger');
        });
    }
    
    // Clear filters
    function clearFilters() {
        window.location.href = '{% url "jobs:list" %}';
    }
    
    // Remove specific filter
    function removeFilter(filterType) {
        const form = document.getElementById('filtersForm');
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        // Add all form data except the filter to remove
        for (let [key, value] of formData.entries()) {
            if (filterType === 'salary' && (key === 'salary_min' || key === 'salary_max')) {
                continue;
            } else if (key === filterType) {
                continue;
            } else if (value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = newUrl;
    }
    
    // Auto-submit filters with debouncing
    let filterTimeout;
    function debounceFilter() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            document.getElementById('filtersForm').submit();
        }, 500);
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Add real-time search
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.addEventListener('input', debounceFilter);
        }
        
        // Add filter change listeners
        const filterSelects = document.querySelectorAll('.filter-select');
        filterSelects.forEach(select => {
            select.addEventListener('change', () => {
                document.getElementById('filtersForm').submit();
            });
        });
        
        // Stagger animation for job cards
        const jobCards = document.querySelectorAll('.job-card');
        jobCards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });
        
        // Smooth scroll to top when changing pages
        if (window.location.search.includes('page=')) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Add hover effects
        jobCards.forEach(card => {
            const title = card.querySelector('.job-title');
            const originalColor = getComputedStyle(title).color;
            
            card.addEventListener('mouseenter', () => {
                title.style.color = 'var(--primary-color)';
            });
            
            card.addEventListener('mouseleave', () => {
                title.style.color = originalColor;
            });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + F to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f' && searchInput) {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
        });
        
        // Infinite scroll (optional enhancement)
        let isLoading = false;
        window.addEventListener('scroll', function() {
            if (isLoading) return;
            
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            
            if (scrollTop + clientHeight >= scrollHeight - 1000) {
                // Near bottom - could implement infinite scroll here
                // For now, this is just a placeholder for future enhancement
            }
        });
    });
    
    // Utility function for URL parameters
    function updateUrlParam(key, value) {
        const url = new URL(window.location);
        if (value) {
            url.searchParams.set(key, value);
        } else {
            url.searchParams.delete(key);
        }
        window.history.replaceState({}, '', url);
    }
    
    // Format numbers for display
    function formatNumber(num) {
        return new Intl.NumberFormat('tr-TR').format(num);
    }
    
    // Share job function
    function shareJob(jobId, jobTitle) {
        if (navigator.share) {
            navigator.share({
                title: jobTitle,
                text: `${jobTitle} iş ilanını incele`,
                url: window.location.origin + `{% url 'jobs:detail' 0 %}`.replace('0', jobId)
            });
        } else {
            // Fallback: copy to clipboard
            const url = window.location.origin + `{% url 'jobs:detail' 0 %}`.replace('0', jobId);
            navigator.clipboard.writeText(url).then(() => {
                App.showToast('İlan bağlantısı kopyalandı!', 'success');
            });
        }
    }
</script>
<!-- Advanced Search JavaScript - jobs_list.html'e eklenecek -->

<style>
/* Advanced Search Styles */
.search-autocomplete {
    position: relative;
}

.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm);
    box-shadow: var(--shadow-md);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.autocomplete-item {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: var(--transition);
    border-bottom: 1px solid var(--border-color);
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:hover,
.autocomplete-item.active {
    background: var(--light-color);
    color: var(--primary-color);
}

.autocomplete-icon {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
    font-size: 14px;
}

.autocomplete-item:hover .autocomplete-icon,
.autocomplete-item.active .autocomplete-icon {
    color: var(--primary-color);
}

.autocomplete-text {
    flex: 1;
    font-size: 14px;
}

.autocomplete-type {
    font-size: 12px;
    color: var(--text-muted);
    background: var(--light-color);
    padding: 2px 8px;
    border-radius: 12px;
}

.search-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: var(--text-muted);
}

.no-results {
    padding: 20px;
    text-align: center;
    color: var(--text-muted);
    font-size: 14px;
}

.quick-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}

.quick-filter {
    padding: 6px 12px;
    background: var(--light-color);
    color: var(--text-muted);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    font-size: 12px;
    cursor: pointer;
    transition: var(--transition);
}

.quick-filter:hover {
    background: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
}

.quick-filter.active {
    background: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
}

.search-stats {
    padding: 12px 16px;
    background: #f8fafc;
    border-bottom: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--text-muted);
}

.advanced-search-toggle {
    margin-top: 8px;
    font-size: 12px;
    color: var(--primary-color);
    cursor: pointer;
    text-decoration: underline;
}

.advanced-search-panel {
    display: none;
    margin-top: 16px;
    padding: 16px;
    background: #f8fafc;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--border-color);
}

.advanced-search-panel.show {
    display: block;
}

.search-suggestions {
    margin-top: 12px;
}

.suggestion-category {
    margin-bottom: 12px;
}

.suggestion-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.suggestion-items {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.suggestion-item {
    padding: 4px 8px;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    font-size: 11px;
    cursor: pointer;
    transition: var(--transition);
}

.suggestion-item:hover {
    background: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
}
</style>

<script>
class AdvancedSearch {
    constructor() {
        this.searchInput = document.getElementById('search');
        this.autocompleteDropdown = null;
        this.debounceTimer = null;
        this.currentSelection = -1;
        this.suggestions = [];
        this.cache = new Map();
        
        this.init();
    }
    
    init() {
        if (!this.searchInput) return;
        
        this.createAutocompleteDropdown();
        this.bindEvents();
        this.loadQuickFilters();
        this.loadSearchSuggestions();
    }
    
    createAutocompleteDropdown() {
        // Create autocomplete container
        const container = document.createElement('div');
        container.className = 'search-autocomplete';
        
        // Wrap search input
        this.searchInput.parentNode.insertBefore(container, this.searchInput);
        container.appendChild(this.searchInput);
        
        // Create dropdown
        this.autocompleteDropdown = document.createElement('div');
        this.autocompleteDropdown.className = 'autocomplete-dropdown';
        container.appendChild(this.autocompleteDropdown);
    }
    
    bindEvents() {
        // Search input events
        this.searchInput.addEventListener('input', (e) => {
            this.handleSearchInput(e.target.value);
        });
        
        this.searchInput.addEventListener('keydown', (e) => {
            this.handleKeyNavigation(e);
        });
        
        this.searchInput.addEventListener('focus', () => {
            if (this.suggestions.length > 0) {
                this.showDropdown();
            }
        });
        
        // Click outside to close
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-autocomplete')) {
                this.hideDropdown();
            }
        });
        
        // Form submission
        const form = document.getElementById('filtersForm');
        if (form) {
            form.addEventListener('submit', (e) => {
                this.logSearch();
            });
        }
    }
    
    handleSearchInput(value) {
        clearTimeout(this.debounceTimer);
        
        if (value.length < 2) {
            this.hideDropdown();
            return;
        }
        
        this.debounceTimer = setTimeout(() => {
            this.fetchSuggestions(value);
        }, 300);
    }
    
    async fetchSuggestions(query) {
        // Check cache first
        if (this.cache.has(query)) {
            this.displaySuggestions(this.cache.get(query));
            return;
        }
        
        try {
            this.showLoading();
            
            const response = await fetch(`/jobs/api/search/suggestions/?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.suggestions) {
                this.cache.set(query, data.suggestions);
                this.displaySuggestions(data.suggestions);
            }
        } catch (error) {
            console.error('Suggestion fetch error:', error);
            this.hideDropdown();
        }
    }
    
    displaySuggestions(suggestions) {
        this.suggestions = suggestions;
        this.currentSelection = -1;
        
        if (suggestions.length === 0) {
            this.showNoResults();
            return;
        }
        
        let html = '';
        
        suggestions.forEach((suggestion, index) => {
            html += `
                <div class="autocomplete-item" data-index="${index}" data-type="${suggestion.type}" data-text="${suggestion.text}">
                    <i class="fas fa-${suggestion.icon} autocomplete-icon"></i>
                    <span class="autocomplete-text">${suggestion.display}</span>
                    <span class="autocomplete-type">${this.getTypeLabel(suggestion.type)}</span>
                </div>
            `;
        });
        
        this.autocompleteDropdown.innerHTML = html;
        this.bindDropdownEvents();
        this.showDropdown();
    }
    
    bindDropdownEvents() {
        const items = this.autocompleteDropdown.querySelectorAll('.autocomplete-item');
        
        items.forEach((item, index) => {
            item.addEventListener('click', () => {
                this.selectSuggestion(index);
            });
            
            item.addEventListener('mouseenter', () => {
                this.setSelection(index);
            });
        });
    }
    
    selectSuggestion(index) {
        const suggestion = this.suggestions[index];
        if (!suggestion) return;
        
        this.searchInput.value = suggestion.text;
        this.hideDropdown();
        
        // Auto-submit form or trigger search
        const form = document.getElementById('filtersForm');
        if (form) {
            // Add suggestion type as hidden field for better filtering
            this.addHiddenFilter(suggestion.type, suggestion.text);
            form.submit();
        }
    }
    
    addHiddenFilter(type, value) {
        const form = document.getElementById('filtersForm');
        
        // Remove existing hidden filters
        const existingHidden = form.querySelectorAll('input[name="suggestion_type"], input[name="suggestion_value"]');
        existingHidden.forEach(input => input.remove());
        
        // Add new hidden filters
        const typeInput = document.createElement('input');
        typeInput.type = 'hidden';
        typeInput.name = 'suggestion_type';
        typeInput.value = type;
        form.appendChild(typeInput);
        
        const valueInput = document.createElement('input');
        valueInput.type = 'hidden';
        valueInput.name = 'suggestion_value';
        valueInput.value = value;
        form.appendChild(valueInput);
    }
    
    handleKeyNavigation(e) {
        if (!this.isDropdownVisible()) return;
        
        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.setSelection(this.currentSelection + 1);
                break;
            
            case 'ArrowUp':
                e.preventDefault();
                this.setSelection(this.currentSelection - 1);
                break;
            
            case 'Enter':
                e.preventDefault();
                if (this.currentSelection >= 0) {
                    this.selectSuggestion(this.currentSelection);
                }
                break;
            
            case 'Escape':
                this.hideDropdown();
                break;
        }
    }
    
    setSelection(index) {
        const items = this.autocompleteDropdown.querySelectorAll('.autocomplete-item');
        
        // Remove previous selection
        items.forEach(item => item.classList.remove('active'));
        
        // Clamp index
        if (index < 0) index = items.length - 1;
        if (index >= items.length) index = 0;
        
        this.currentSelection = index;
        
        // Add new selection
        if (items[index]) {
            items[index].classList.add('active');
            items[index].scrollIntoView({ block: 'nearest' });
        }
    }
    
    showDropdown() {
        this.autocompleteDropdown.style.display = 'block';
    }
    
    hideDropdown() {
        this.autocompleteDropdown.style.display = 'none';
        this.currentSelection = -1;
    }
    
    isDropdownVisible() {
        return this.autocompleteDropdown.style.display === 'block';
    }
    
    showLoading() {
        this.autocompleteDropdown.innerHTML = `
            <div class="search-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span style="margin-left: 8px;">Aranıyor...</span>
            </div>
        `;
        this.showDropdown();
    }
    
    showNoResults() {
        this.autocompleteDropdown.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <div>Öneri bulunamadı</div>
            </div>
        `;
        this.showDropdown();
    }
    
    getTypeLabel(type) {
        const labels = {
            'job_title': 'İlan',
            'category': 'Kategori',
            'city': 'Şehir',
            'company': 'Şirket'
        };
        return labels[type] || 'Diğer';
    }
    
    async loadQuickFilters() {
        try {
            const response = await fetch('/jobs/api/search/filters/');
            const data = await response.json();
            
            if (data.success) {
                this.createQuickFilters(data);
            }
        } catch (error) {
            console.error('Quick filters load error:', error);
        }
    }
    
    createQuickFilters(data) {
        const filtersContainer = document.querySelector('.filters-content');
        if (!filtersContainer) return;
        
        const quickFiltersHtml = `
            <div class="quick-filters">
                ${data.categories.slice(0, 5).map(cat => 
                    `<span class="quick-filter" data-type="category" data-value="${cat.id}">${cat.name}</span>`
                ).join('')}
                ${data.cities.slice(0, 3).map(city => 
                    `<span class="quick-filter" data-type="city" data-value="${city.name}">${city.name}</span>`
                ).join('')}
            </div>
        `;
        
        filtersContainer.insertAdjacentHTML('afterbegin', quickFiltersHtml);
        
        // Bind quick filter events
        document.querySelectorAll('.quick-filter').forEach(filter => {
            filter.addEventListener('click', (e) => {
                this.applyQuickFilter(e.target);
            });
        });
    }
    
    applyQuickFilter(filterElement) {
        const type = filterElement.dataset.type;
        const value = filterElement.dataset.value;
        
        // Update form fields
        const form = document.getElementById('filtersForm');
        if (type === 'category') {
            const categorySelect = form.querySelector('[name="category"]');
            if (categorySelect) categorySelect.value = value;
        } else if (type === 'city') {
            const citySelect = form.querySelector('[name="city"]');
            if (citySelect) citySelect.value = value;
        }
        
        // Visual feedback
        filterElement.classList.add('active');
        setTimeout(() => {
            form.submit();
        }, 200);
    }
    
    async loadSearchSuggestions() {
        try {
            const response = await fetch('/jobs/api/search/analytics/');
            const data = await response.json();
            
            if (data.success) {
                this.createSearchSuggestions(data);
            }
        } catch (error) {
            console.error('Search suggestions load error:', error);
        }
    }
    
    createSearchSuggestions(data) {
        const searchContainer = this.searchInput.closest('.filter-group');
        if (!searchContainer) return;
        
        const suggestionsHtml = `
            <div class="search-suggestions">
                <div class="suggestion-category">
                    <div class="suggestion-title">Popüler Aramalar</div>
                    <div class="suggestion-items">
                        ${data.trending_searches.slice(0, 6).map(search => 
                            `<span class="suggestion-item" data-search="${search}">${search}</span>`
                        ).join('')}
                    </div>
                </div>
                
                <div class="suggestion-category">
                    <div class="suggestion-title">Popüler Şehirler</div>
                    <div class="suggestion-items">
                        ${data.trending_cities.slice(0, 4).map(city => 
                            `<span class="suggestion-item" data-city="${city.name}">${city.name} (${city.new_jobs})</span>`
                        ).join('')}
                    </div>
                </div>
            </div>
        `;
        
        searchContainer.insertAdjacentHTML('beforeend', suggestionsHtml);
        
        // Bind suggestion events
        document.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', (e) => {
                this.applySuggestion(e.target);
            });
        });
    }
    
    applySuggestion(suggestionElement) {
        const form = document.getElementById('filtersForm');
        
        if (suggestionElement.dataset.search) {
            this.searchInput.value = suggestionElement.dataset.search;
        } else if (suggestionElement.dataset.city) {
            const citySelect = form.querySelector('[name="city"]');
            if (citySelect) citySelect.value = suggestionElement.dataset.city;
        }
        
        // Visual feedback
        suggestionElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            suggestionElement.style.transform = '';
            form.submit();
        }, 150);
    }
    
    async logSearch() {
        const query = this.searchInput.value.trim();
        if (!query) return;
        
        try {
            await fetch('/jobs/api/search/log/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': App.getCsrfToken()
                },
                body: JSON.stringify({
                    query: query,
                    filters: this.getActiveFilters(),
                    timestamp: new Date().toISOString()
                })
            });
        } catch (error) {
            console.error('Search logging error:', error);
        }
    }
    
    getActiveFilters() {
        const form = document.getElementById('filtersForm');
        const formData = new FormData(form);
        const filters = {};
        
        for (let [key, value] of formData.entries()) {
            if (value.trim()) {
                filters[key] = value;
            }
        }
        
        return filters;
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize advanced search
    new AdvancedSearch();
    
    // Add search stats to results header
    addSearchStats();
    
    // Enhanced filter animations
    enhanceFilterAnimations();
});

function addSearchStats() {
    const resultsHeader = document.querySelector('.results-header');
    const searchInput = document.getElementById('search');
    
    if (resultsHeader && searchInput && searchInput.value.trim()) {
        const query = searchInput.value.trim();
        const statsHtml = `
            <div class="search-stats">
                <i class="fas fa-search"></i>
                "${query}" için arama sonuçları
                <span class="advanced-search-toggle" onclick="toggleAdvancedSearch()">
                    Gelişmiş Arama
                </span>
            </div>
        `;
        
        resultsHeader.insertAdjacentHTML('beforeend', statsHtml);
    }
}

function toggleAdvancedSearch() {
    const panel = document.querySelector('.advanced-search-panel');
    if (!panel) {
        createAdvancedSearchPanel();
    } else {
        panel.classList.toggle('show');
    }
}

function createAdvancedSearchPanel() {
    const filtersContainer = document.querySelector('.filters-content');
    if (!filtersContainer) return;
    
    const panelHtml = `
        <div class="advanced-search-panel show">
            <h4 style="margin-bottom: 12px;">Gelişmiş Arama Seçenekleri</h4>
            
            <div class="form-group">
                <label class="form-label">Sıralama</label>
                <select class="form-control" name="sort" onchange="document.getElementById('filtersForm').submit()">
                    <option value="newest">En Yeni</option>
                    <option value="oldest">En Eski</option>
                    <option value="salary_high">Maaş (Yüksek→Düşük)</option>
                    <option value="salary_low">Maaş (Düşük→Yüksek)</option>
                    <option value="popular">En Çok Görüntülenen</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Tarih Aralığı</label>
                <select class="form-control" name="date_range" onchange="document.getElementById('filtersForm').submit()">
                    <option value="">Tüm Zamanlar</option>
                    <option value="today">Bugün</option>
                    <option value="week">Son 7 Gün</option>
                    <option value="month">Son 30 Gün</option>
                </select>
            </div>
        </div>
    `;
    
    filtersContainer.insertAdjacentHTML('beforeend', panelHtml);
}

function enhanceFilterAnimations() {
    const filterInputs = document.querySelectorAll('.filter-input, .filter-select');
    
    filterInputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.style.transform = 'translateY(-2px)';
            this.parentElement.style.boxShadow = 'var(--shadow-md)';
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.style.transform = '';
            this.parentElement.style.boxShadow = '';
        });
    });
}

// Real-time search results (optional enhancement)
class RealTimeSearch {
    constructor() {
        this.searchInput = document.getElementById('search');
        this.resultsContainer = document.querySelector('.jobs-list');
        this.debounceTimer = null;
        
        if (this.searchInput && this.resultsContainer) {
            this.init();
        }
    }
    
    init() {
        this.searchInput.addEventListener('input', (e) => {
            this.handleRealTimeSearch(e.target.value);
        });
    }
    
    handleRealTimeSearch(query) {
        clearTimeout(this.debounceTimer);
        
        if (query.length < 3) return;
        
        this.debounceTimer = setTimeout(() => {
            this.performRealTimeSearch(query);
        }, 800);
    }
    
    async performRealTimeSearch(query) {
        try {
            const url = new URL('/jobs/api/search/advanced/', window.location.origin);
            url.searchParams.set('q', query);
            url.searchParams.set('limit', '5');
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.results.length > 0) {
                this.showRealTimeResults(data.results);
            }
        } catch (error) {
            console.error('Real-time search error:', error);
        }
    }
    
    showRealTimeResults(results) {
        // Could implement a small preview overlay
        // For now, just log the results
        console.log('Real-time results:', results);
    }
}

// Initialize real-time search if needed
// new RealTimeSearch();
</script>
{% endblock %}
